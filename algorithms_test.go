package gdal_test

import (
	"fmt"
	"testing"

	gdal "github.com/seerai/godal"
	"github.com/stretchr/testify/assert"
)

var testRPCData = []string{
	"HEIGHT_OFF=208.26086044311523",
	"HEIGHT_SCALE=112.35467910766602",
	"LAT_OFF=30.36318307376677",
	"LAT_SCALE=0.021446967770998526",
	"LINE_DEN_COEFF= 1 -5.33186048884636e-05 0.0008811920378228538 -8.01728769033774e-06 -2.667176518187263e-06 -3.670422664556495e-08 -8.336440882551595e-07 -8.222978435200636e-06 2.7014151229793275e-05 -8.823224331459857e-06 -1.074203044259754e-08 -2.4119915034183506e-06 1.5132257376727735e-08 4.5822694369731577e-10 7.799283854815695e-07 -4.2831064136291015e-07 1.2281629391871357e-10 4.778599385527892e-08 -3.522467895573358e-10 7.772068518684073e-11",
	"LINE_NUM_COEFF= 0.0017588086789607081 0.02660754330712328 -1.028260421605862 0.008372801989695871 -1.0036862342058624e-05 2.451517489829891e-07 6.526027527765828e-06 -0.00013243673677821498 -0.0009019776618798803 -1.5889935167275862e-07 8.990053353794163e-08 1.0665314394940678e-06 -2.0866665837685192e-06 -2.352708812001208e-07 7.91226367341885e-06 4.2063628188819546e-05 9.079110467165015e-06 -9.596861316764418e-08 -6.262723610892668e-07 -7.39085371782502e-08",
	"LINE_OFF=1868.5",
	"LINE_SCALE=1871.5",
	"LONG_OFF=-97.78131948082907",
	"LONG_SCALE=0.02358065258173525",
	"SAMP_DEN_COEFF= 1 0.00039891903574530664 0.0002133043650022998 -9.970750113614404e-05 -8.858430066832499e-07 -5.395198993156794e-08 6.190253771164834e-09 9.075672076948001e-07 9.442451371757771e-07 -3.560628374372286e-07 1.5740852341598304e-08 1.4637455292464607e-06 5.219197851034593e-07 2.492582525066367e-10 -1.6735771571130725e-06 -9.006026653542886e-08 -1.902714524176422e-10 -1.8882153920863617e-08 -1.4373726009247064e-09 6.667444249364315e-11",
	"SAMP_NUM_COEFF= -0.0013970949039889585 1.0022484538069611 -0.000798164582067413 -0.00754532878507426 -0.00021401048618658214 8.893441296503563e-05 -3.90005988871615e-05 0.000999052081006483 -0.00019220030322753006 -2.5168946463261795e-07 -6.386267981400613e-08 -1.362175996286118e-07 -1.5370410695246468e-06 -3.426772485163444e-07 1.952948255880301e-06 8.837949839282748e-06 -1.9823341780035344e-09 1.732209111031079e-07 -1.926331078906914e-07 2.6045680278062227e-09",
	"SAMP_OFF=1825",
	"SAMP_SCALE=1828",
}

func TestRPCs(t *testing.T) {
	rpcs, err := gdal.ExtractRPCInfoV2(testRPCData)
	assert.NoError(t, err)

	_, err = gdal.ExtractRPCInfoV2([]string{"HEIGHT_OFF=208.26086044311523"})
	assert.Error(t, err)

	tr := gdal.CreateRPCTransformer(rpcs, true, 0.0, []string{})
	defer tr.Destroy()
	fmt.Println(rpcs)

	x := []float64{0.0, 3651.0, 0, 3651.0}
	y := []float64{0.0, 0.0, 3738.0, 3738.0}
	z := []float64{0.0, 0.0, 0.0, 0.0}

	xo, yo, zo, err := tr.Transform(x, y, z, false)
	assert.NoError(t, err)
	assert.InDelta(t, 30.383166198093733, yo[0], 0.000001)
	assert.InDelta(t, -97.80512372559033, xo[0], 0.000001)
	assert.InDelta(t, 30.342609346638866, yo[3], 0.000001)
	assert.InDelta(t, -97.75814680500771, xo[3], 0.000001)
	assert.Equal(t, 0.0, zo[0])
}
